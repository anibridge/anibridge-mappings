name: Publish Mappings

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  OUTPUT_DIR: "data/out"

jobs:
  build:
    environment: publish
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.vars.outputs.release_tag }}
      release_date: ${{ steps.vars.outputs.release_date }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Compute workflow vars
        id: vars
        run: |
          set -euo pipefail
          echo "cache_month=$(date -u +%Y-%m)" >> "$GITHUB_OUTPUT"
          echo "release_date=$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"
          echo "release_tag=mappings-$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

      - name: Cache metadata
        uses: actions/cache@v5
        with:
          path: data/meta
          key: meta-${{ runner.os }}-${{ steps.vars.outputs.cache_month }}
          restore-keys: |
            meta-${{ runner.os }}-

      - name: Determine previous release
        id: prevrel
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          today="${{ steps.vars.outputs.release_tag }}"
          prev=$(gh release list --limit 50 --json tagName --jq '.[].tagName' | grep -vx "$today" | head -n 1 || true)
          echo "previous_tag=$prev" >> "$GITHUB_OUTPUT"

      - name: Download previous mappings.json
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          prev="${{ steps.prevrel.outputs.previous_tag }}"
          if [ -n "$prev" ]; then
            rm -rf /tmp/prev-release
            mkdir -p /tmp/prev-release
            gh release download "$prev" -p "data-out.zip" -D /tmp/prev-release || true
            if ls /tmp/prev-release/*.zip >/dev/null 2>&1; then
              unzip -p /tmp/prev-release/*.zip "data/out/mappings.json" > /tmp/mappings.old.json || true
            fi
          fi
          if [ ! -s /tmp/mappings.old.json ]; then
            : > /tmp/mappings.old.json
          fi

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: uv sync --locked

      - name: Build mappings
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        run: |
          uv run ./main.py --out "$OUTPUT_DIR" --compress --stats --provenance

      - name: Package output
        run: |
          set -euo pipefail
          rm -f /tmp/data-out.zip
          if [ ! -d "$OUTPUT_DIR" ]; then
            echo "Missing $OUTPUT_DIR" >&2
            exit 1
          fi
          zip -r /tmp/data-out.zip "$OUTPUT_DIR"

      - name: Upload release artifact
        uses: actions/upload-artifact@v6
        with:
          name: data-out
          path: /tmp/data-out.zip
          if-no-files-found: error

      - name: Write workflow summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## Mapping build summary"
            echo ""
            echo "### stats.json"
            if [ -f "$OUTPUT_DIR/stats.json" ]; then
              echo "\`\`\`json"
              cat "$OUTPUT_DIR/stats.json"
              echo "\`\`\`"
            else
              echo "stats.json not found."
            fi
            echo ""
            echo "### mappings.json diff"
            if [ -f "/tmp/mappings.old.json" ] && [ -f "$OUTPUT_DIR/mappings.json" ]; then
              echo "\`\`\`diff"
              diff -u /tmp/mappings.old.json "$OUTPUT_DIR/mappings.json" || true
              echo "\`\`\`"
            else
              echo "mappings.json diff unavailable."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  publish-release:
    if: ${{ github.event_name != 'pull_request' }}
    needs: build
    environment: publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: data-out
          path: /tmp

      - name: Create or update daily release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          tag="${{ needs.build.outputs.release_tag }}"
          date_str="${{ needs.build.outputs.release_date }}"
          asset="/tmp/data-out.zip"
          if [ ! -f "$asset" ]; then
            echo "Missing release asset: $asset" >&2
            exit 1
          fi

          # Re-runs for the same day should replace the release.
          gh release view "$tag" >/dev/null 2>&1 && gh release delete "$tag" -y --cleanup-tag || true
          gh release create "$tag" "$asset" \
            --title "Mappings $date_str" \
            --notes "Automated daily mappings build."

      - name: Keep only last 30 releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mapfile -t tags < <(gh release list --limit 200 --json tagName --jq '.[].tagName')
          if [ ${#tags[@]} -le 30 ]; then
            exit 0
          fi

          for tag in "${tags[@]:30}"; do
            gh release delete "$tag" -y --cleanup-tag || true
          done
