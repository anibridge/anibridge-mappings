name: Publish Mappings

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  OUTPUT_DIR: "data/out"

jobs:
  build:
    environment: publish
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.vars.outputs.release_tag }}
      release_date: ${{ steps.vars.outputs.release_date }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Compute workflow vars
        id: vars
        run: |
          set -euo pipefail
          echo "cache_month=$(date -u +%Y-%m)" >> "$GITHUB_OUTPUT"
          echo "release_date=$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"
          echo "release_tag=mappings-$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

      - name: Cache metadata
        id: cache-meta
        uses: actions/cache@v5
        with:
          path: data/meta
          key: meta-${{ steps.vars.outputs.cache_month }}-${{ github.run_id }}
          restore-keys: |
            meta-${{ steps.vars.outputs.cache_month }}-
            meta-

      - name: Determine previous release
        id: prevrel
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          today="${{ steps.vars.outputs.release_tag }}"
          prev=$(gh release list --limit 50 --json tagName --jq '.[].tagName' | grep -vx "$today" | head -n 1 || true)
          echo "previous_tag=$prev" >> "$GITHUB_OUTPUT"

      - name: Download previous mappings.json
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          prev="${{ steps.prevrel.outputs.previous_tag }}"
          if [ -n "$prev" ]; then
            rm -rf /tmp/prev-release
            mkdir -p /tmp/prev-release
            gh release download "$prev" -p "mappings.json" -D /tmp/prev-release || true
            if [ -f /tmp/prev-release/mappings.json ]; then
              cp /tmp/prev-release/mappings.json /tmp/mappings.old.json
            fi
          fi
          if [ ! -s /tmp/mappings.old.json ]; then
            : > /tmp/mappings.old.json
          fi

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: uv sync --locked

      - name: Build mappings
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TVDB_API_KEY: ${{ secrets.TVDB_API_KEY }}
        run: |
          uv run ./main.py --out "$OUTPUT_DIR" --compress --stats --provenance

      - name: Upload release artifact
        uses: actions/upload-artifact@v6
        with:
          name: data-out
          path: ${{ env.OUTPUT_DIR }}
          if-no-files-found: error

      - name: Write mappings diff file
        run: |
          set -euo pipefail
          if [ -f "/tmp/mappings.old.json" ] && [ -f "$OUTPUT_DIR/mappings.json" ]; then
            diff -u /tmp/mappings.old.json "$OUTPUT_DIR/mappings.json" > /tmp/mappings.diff || true
          else
            : > /tmp/mappings.diff
          fi

      - name: Upload mappings diff artifact
        uses: actions/upload-artifact@v6
        with:
          name: mappings-diff
          path: /tmp/mappings.diff
          if-no-files-found: error

      - name: Write workflow summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## Mapping build summary"
            echo ""
            echo "### stats.json"
            if [ -f "$OUTPUT_DIR/stats.json" ]; then
              echo "\`\`\`json"
              cat "$OUTPUT_DIR/stats.json"
              echo "\`\`\`"
            else
              echo "stats.json not found."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  publish-release:
    if: ${{ github.event_name != 'pull_request' }}
    needs: build
    environment: publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v7
        with:
          name: data-out
          path: /tmp/artifact

      - name: Prepare release assets
        shell: bash
        run: |
          set -euo pipefail
          out_dir="/tmp/artifact"
          find /tmp/artifact -maxdepth 4 -type d -print >&2 || true # debugging
          if [ ! -d "$out_dir" ]; then
            echo "Missing artifact output dir: $out_dir" >&2
            exit 1
          fi

          rm -rf /tmp/release-assets
          mkdir -p /tmp/release-assets

          shopt -s nullglob
          while IFS= read -r -d '' file; do
            rel="${file#"$out_dir/"}"
            asset_name="${rel//\//__}"
            cp "$file" "/tmp/release-assets/$asset_name"
          done < <(find "$out_dir" -type f -print0)

          if [ -z "$(ls -A /tmp/release-assets)" ]; then
            echo "No files found in $out_dir" >&2
            exit 1
          fi

      - name: Create or update daily release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.release_tag }}
          name: Mappings ${{ needs.build.outputs.release_date }}
          body: Automated daily mappings build for ${{ needs.build.outputs.release_date }}.
          files: /tmp/release-assets/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Keep only last 30 releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 30
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ github.token }}
