name: Publish Mappings

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  OUTPUT_DIR: "data/out"

jobs:
  build:
    environment: publish
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.vars.outputs.release_tag }}
      release_major: ${{ steps.vars.outputs.release_major }}
      release_date: ${{ steps.vars.outputs.release_date }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Compute cache vars
        id: cache-vars
        run: |
          set -euo pipefail
          echo "cache_month=$(date -u +%Y-%m)" >> "$GITHUB_OUTPUT"

      - name: Cache metadata
        id: cache-meta
        uses: actions/cache@v5
        with:
          path: data/meta
          key: meta-${{ steps.cache-vars.outputs.cache_month }}-${{ github.run_id }}
          restore-keys: |
            meta-${{ steps.cache-vars.outputs.cache_month }}-
            meta-

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: uv sync --locked

      - name: Compute release vars
        id: vars
        run: |
          set -euo pipefail
          version=$(uv run python -c "import importlib.metadata; print(importlib.metadata.version('anibridge-mappings'))")
          major="${version%%.*}"
          echo "release_date=$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"
          echo "release_major=v$major" >> "$GITHUB_OUTPUT"
          echo "release_tag=mappings-v$major" >> "$GITHUB_OUTPUT"

      - name: Download previous mappings.json
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          rm -rf /tmp/prev-release
          mkdir -p /tmp/prev-release
          gh release download "${{ steps.vars.outputs.release_tag }}" -p "mappings.json" -D /tmp/prev-release || true
          if [ -f /tmp/prev-release/mappings.json ]; then
            cp /tmp/prev-release/mappings.json /tmp/mappings.old.json
          fi
          if [ ! -s /tmp/mappings.old.json ]; then
            : > /tmp/mappings.old.json
          fi

      - name: Build mappings
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TVDB_API_KEY: ${{ secrets.TVDB_API_KEY }}
        run: |
          uv run ./main.py --out "$OUTPUT_DIR" --compress --stats --provenance

      - name: Upload release artifact
        uses: actions/upload-artifact@v6
        with:
          name: data-out
          path: ${{ env.OUTPUT_DIR }}
          if-no-files-found: error

      - name: Write workflow summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## Mapping build summary"
            echo ""
            echo "### stats.json"
            if [ -f "$OUTPUT_DIR/stats.json" ]; then
              echo "\`\`\`json"
              cat "$OUTPUT_DIR/stats.json"
              echo "\`\`\`"
            else
              echo "stats.json not found."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  diff:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v7
        with:
          name: data-out
          path: /tmp/artifact

      - name: Download previous mappings.json
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          rm -rf /tmp/prev-release
          mkdir -p /tmp/prev-release
          gh release download "${{ needs.build.outputs.release_tag }}" -p "mappings.json" -D /tmp/prev-release || true

      - name: diff
        run: |
          set -euo pipefail
          old_file="/tmp/prev-release/mappings.json"
          new_file="/tmp/artifact/mappings.json"

          if [ ! -f "$new_file" ]; then
            echo "Current mappings.json not found at $new_file"
            exit 1
          fi

          if [ ! -f "$old_file" ]; then
            echo "No previous mappings.json found for ${{ needs.build.outputs.release_tag }}"
            exit 0
          fi

          diff -u --color=auto "$old_file" "$new_file" || true

  publish-release:
    if: ${{ github.event_name != 'pull_request' }}
    needs:
      - build
      - diff
    environment: publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v7
        with:
          name: data-out
          path: /tmp/artifact

      - name: Prepare release assets
        shell: bash
        run: |
          set -euo pipefail
          out_dir="/tmp/artifact"
          if [ ! -d "$out_dir" ]; then
            echo "Missing artifact output dir: $out_dir" >&2
            exit 1
          fi

          rm -rf /tmp/release-assets
          mkdir -p /tmp/release-assets

          shopt -s nullglob
          while IFS= read -r -d '' file; do
            rel="${file#"$out_dir/"}"
            asset_name="${rel//\//__}"
            cp "$file" "/tmp/release-assets/$asset_name"
          done < <(find "$out_dir" -type f -print0)

          if [ -z "$(ls -A /tmp/release-assets)" ]; then
            echo "No files found in $out_dir" >&2
            exit 1
          fi

      - name: Create or update major release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.release_tag }}
          name: Mappings ${{ needs.build.outputs.release_major }}
          body: |
            Automated rolling mappings build for major version ${{ needs.build.outputs.release_major }}.

            Last updated: ${{ needs.build.outputs.release_date }}.
          files: /tmp/release-assets/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ github.token }}
