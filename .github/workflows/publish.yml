name: Publish Mappings

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  OUTPUT_DIR: "data/out"
  OUTPUT_BRANCH: "v3"

jobs:
  build-and-publish:
    environment: publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Compute cache month
        id: cachevars
        run: |
          set -euo pipefail
          echo "month=$(date -u +%Y-%m)" >> "$GITHUB_OUTPUT"

      - name: Cache metadata
        uses: actions/cache@v5
        with:
          path: data/meta
          key: meta-${{ runner.os }}-${{ steps.cachevars.outputs.month }}
          restore-keys: |
            meta-${{ runner.os }}-

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: uv sync --locked

      - name: Build mappings
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        run: |
          uv run ./main.py --out "$OUTPUT_DIR" --compress --stats --provenance

      - name: Capture previous mappings
        id: prev
        run: |
          set -euo pipefail
          git fetch origin "$OUTPUT_BRANCH" --depth=1 || true
          if git rev-parse --verify "origin/$OUTPUT_BRANCH" >/dev/null 2>&1; then
            git show "origin/$OUTPUT_BRANCH:$OUTPUT_DIR/mappings.json" > /tmp/mappings.old.json || true
          else
            : > /tmp/mappings.old.json
          fi

      - name: Publish output to branch
        if: ${{ github.event_name != 'pull_request' }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          rm -rf /tmp/output-branch
          mkdir -p /tmp/output-branch
          cp -R "$OUTPUT_DIR" /tmp/output-branch/

          git checkout --orphan "$OUTPUT_BRANCH"
          git reset --hard
          git clean -fdx
          cp -R /tmp/output-branch/* .
          git add -A
          git commit -m "Update mappings ($(date -u +%Y-%m-%d))"
          git push --force origin "$OUTPUT_BRANCH"

      - name: Write workflow summary
        if: always()
        run: |
          set -euo pipefail
          {
            echo "## Mapping build summary"
            echo ""
            echo "### stats.json"
            if [ -f "$OUTPUT_DIR/stats.json" ]; then
              echo "\`\`\`json"
              cat "$OUTPUT_DIR/stats.json"
              echo "\`\`\`"
            else
              echo "stats.json not found."
            fi
            echo ""
            echo "### mappings.json diff"
            if [ -f "/tmp/mappings.old.json" ] && [ -f "$OUTPUT_DIR/mappings.json" ]; then
              echo "\`\`\`diff"
              diff -u /tmp/mappings.old.json "$OUTPUT_DIR/mappings.json" || true
              echo "\`\`\`"
            else
              echo "mappings.json diff unavailable."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
